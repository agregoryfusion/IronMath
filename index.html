<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IronMath</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1, h2 { color: #1e90ff; }
    button {
      background-color: #0078D7;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    button:hover { background-color: #005fa3; }
    input {
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px;
      font-size: 18px;
      text-align: center;
      width: 100px;
    }
    #game-container, #end-screen, #leaderboardContainer { display: none; }
    table {
      width: 80%;
      margin: 20px auto;
      border-collapse: collapse;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #333;
    }
    th { color: #1e90ff; }
    #timerBar {
      width: 80%;
      height: 20px;
      background: #333;
      border-radius: 10px;
      margin: 20px auto;
      overflow: hidden;
    }
    #timerFill {
      height: 100%;
      background: #1e90ff;
      width: 100%;
      transition: width 0.1s linear;
    }
  </style>
</head>
<body>
  <h1>IronMath</h1>

  <!-- Sign-In Screen -->
  <div id="login-screen">
    <p>Please sign in with your Microsoft account to continue.</p>
    <button id="loginBtn">Sign in with Microsoft</button>
    <p id="loginStatus" style="color:#f55;"></p>
  </div>

  <!-- Game Container -->
  <div id="game-container">
    <h2 id="question"></h2>
    <div id="timerBar"><div id="timerFill"></div></div>
    <input id="answer" type="text" autocomplete="off" />
    <p id="stage-info"></p>
  </div>

  <!-- End Screen -->
  <div id="end-screen">
    <h2>Game Over</h2>
    <p id="finalStats"></p>
    <button id="restartBtn">Restart</button>
    <button id="viewLeaderboardBtn">View Leaderboard</button>

    <div id="leaderboardContainer" style="display:none; margin-top:20px;">
      <p id="leaderboardStatus" style="color:#ccc;"></p>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Player</th>
            <th>Stage</th>
            <th>Questions</th>
            <th>Time (s)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase + Game Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,
      OAuthProvider,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---- Fill in your Firebase Config here ----
const firebaseConfig = {
  apiKey: "AIzaSyBUaOrUckCuTrc9MHB9jCF4TUsx-hWFC7g",
  authDomain: "ironmath-1263b.firebaseapp.com",
  projectId: "ironmath-1263b",
  storageBucket: "ironmath-1263b.firebasestorage.app",
  messagingSenderId: "729878130193",
  appId: "1:729878130193:web:f4d447b552e4f955f80bb0",
  measurementId: "G-0VCM7C1HPC"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const loginScreen = document.getElementById("login-screen");
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");
    const gameContainer = document.getElementById("game-container");
    const endScreen = document.getElementById("end-screen");
    const questionEl = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const stageInfo = document.getElementById("stage-info");
    const timerFill = document.getElementById("timerFill");
    const finalStats = document.getElementById("finalStats");

    const viewBtn = document.getElementById("viewLeaderboardBtn");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const tbody = document.querySelector("#leaderboardContainer tbody");
    const statusEl = document.getElementById("leaderboardStatus");

    let playerName = "Unknown";
    let sessionId = Math.random().toString(36).substring(2, 8);
    let stage = 8;
    let running = false;
    let totalQuestions = 0;
    let correctAnswers = 0;
    let totalTime = 0;
    let penaltyTime = 0;
    let avgTime = 0;
    let startTime;
    let timer = 10;
    let timerInterval;
    let penaltyMultiplier = 2;
    let recentAnswers = [];
    let duplicateProtectionCount = 25;

    const sigma = 6;
    const stageStretch = 0.5;
    const weightDecay = 0.9;

    let questionStart;
    let currentQuestion;
    let weightMap = {};

    // --- Microsoft Login ---
    loginBtn.addEventListener("click", async () => {
      const provider = new OAuthProvider("microsoft.com");
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        playerName = user.displayName || parseEmailToName(user.email);
        loginScreen.style.display = "none";
        startGame();
      } catch (error) {
        console.error(error);
        loginStatus.textContent = "Sign-in failed: " + error.message;
      }
    });

    function parseEmailToName(email) {
      if (!email) return "Unknown";
      const local = email.split("@")[0];
      if (local.includes(".")) {
        const [f, l] = local.split(".");
        return `${capitalize(f)} ${capitalize(l)}`;
      } else return capitalize(local);
    }
    function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }

    // --- Game logic ---
    function startGame() {
      gameContainer.style.display = "block";
      running = true;
      nextQuestion();
    }

    function randomQuestion() {
      const range = stage + Math.sqrt(stage) * stageStretch;
      const floor = Math.max(1, Math.sqrt(stage) + 1);
      const a = Math.floor(Math.random() * range) + 1;
      const b = Math.floor(Math.random() * range) + 1;
      return [a, b];
    }

    function nextQuestion() {
      clearInterval(timerInterval);
      const [a, b] = randomQuestion();
      const product = a * b;
      if (recentAnswers.includes(product)) return nextQuestion();
      recentAnswers.unshift(product);
      if (recentAnswers.length > duplicateProtectionCount) recentAnswers.pop();
      currentQuestion = { a, b, ans: product };
      questionEl.textContent = `${a} Ã— ${b}`;
      answerEl.value = "";
      stageInfo.textContent = `Stage ${stage}`;
      timer = 10;
      questionStart = performance.now();
      startTimer();
      answerEl.focus();
    }

    function startTimer() {
      const start = performance.now();
      timerInterval = setInterval(() => {
        const elapsed = (performance.now() - start) / 1000;
        const remaining = Math.max(0, 10 - elapsed);
        timerFill.style.width = `${(remaining / 10) * 100}%`;
        if (remaining <= 0) {
          clearInterval(timerInterval);
          endGame();
        }
      }, 100);
    }

    answerEl.addEventListener("input", () => {
      if (!running) return;
      const val = answerEl.value.trim();
      if (val === "") return;
      if (val === currentQuestion.ans.toString()) {
        const qTime = (performance.now() - questionStart) / 1000;
        totalTime += qTime;
        correctAnswers++;
        totalQuestions++;
        avgTime = totalTime / correctAnswers;
        nextQuestion();
      } else if (!currentQuestion.ans.toString().startsWith(val)) {
        penaltyTime += avgTime || 2;
        timer -= avgTime * penaltyMultiplier;
        answerEl.value = val.slice(0, -1);
        if (timer <= 0) endGame();
      }
    });

    function endGame() {
      running = false;
      clearInterval(timerInterval);
      gameContainer.style.display = "none";
      endScreen.style.display = "block";

      const trueTotal = totalTime;
      const modTotal = totalTime + penaltyTime;
      const perQ = (trueTotal / correctAnswers).toFixed(2);
      const perQmod = (modTotal / correctAnswers).toFixed(2);

      finalStats.innerHTML = `
        <strong>Stage:</strong> ${stage}<br>
        <strong>Questions:</strong> ${correctAnswers}<br>
        <strong>Total Time:</strong> ${trueTotal.toFixed(2)} s <span style="color:#888;">(${modTotal.toFixed(2)} s w/ penalty)</span><br>
        <strong>Time/Question:</strong> ${perQ} s <span style="color:#888;">(${perQmod} s w/ penalty)</span><br>
        <strong>Penalty Time:</strong> ${penaltyTime.toFixed(2)} s<br>
        <strong>Session ID:</strong> ${sessionId}
      `;
document.getElementById("restartBtn").addEventListener("click", () => {
  // Reset key variables but keep the signed-in user
  stage = 8;
  totalQuestions = 0;
  correctAnswers = 0;
  totalTime = 0;
  penaltyTime = 0;
  avgTime = 0;
  running = false;
  recentAnswers = [];
  endScreen.style.display = "none";
  gameContainer.style.display = "block";
  startGame();
});
      uploadSession();
    }

    async function uploadSession() {
      try {
        await addDoc(collection(db, "sessions"), {
          playerName,
          sessionId,
          stageReached: stage,
          questionsAnswered: correctAnswers,
          totalTime,
          penaltyTime,
          avgTime,
          dateAdded: Date.now()
        });
      } catch (err) {
        console.error("Upload failed", err);
      }
    }

    // --- Leaderboard ---
    viewBtn?.addEventListener("click", loadLeaderboard);

    async function loadLeaderboard() {
      try {
        statusEl.textContent = "Loading leaderboard...";
        leaderboardContainer.style.display = "block";

        const q = query(
          collection(db, "leaderboard"),
          orderBy("questionsAnswered", "desc"),
          orderBy("totalTime", "asc")
        );
        const snap = await getDocs(q);

        const grouped = {};
        snap.forEach(doc => {
          const d = doc.data();
          if (!d.playerName) return;
          const key = d.playerName.trim().toLowerCase();
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(d);
        });

        const bestRuns = Object.values(grouped).map(entries => {
          return entries.sort((a, b) => {
            if (b.questionsAnswered === a.questionsAnswered)
              return a.totalTime - b.totalTime;
            return b.questionsAnswered - a.questionsAnswered;
          })[0];
        });

        bestRuns.sort((a, b) => {
          if (b.questionsAnswered === a.questionsAnswered)
            return a.totalTime - b.totalTime;
          return b.questionsAnswered - a.questionsAnswered;
        });

        tbody.innerHTML = "";
        let rank = 1;
        for (const d of bestRuns.slice(0, 100)) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${rank++}</td>
            <td>${d.playerName}</td>
            <td>${d.stageReached ?? "?"}</td>
            <td>${d.questionsAnswered ?? "?"}</td>
            <td>${(d.totalTime ?? 0).toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        }

        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to load leaderboard: " + err.message;
      }
    }
  </script>
</body>
</html>
