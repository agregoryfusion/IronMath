<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IronMath</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    h1, h2 { color: #1e90ff; }
    button {
      background-color: #0078D7;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 10px 20px;
      margin: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.2s;
    }
    button:hover { background-color: #005fa3; }
    input {
      background-color: #222;
      color: #fff;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 8px;
      font-size: 18px;
      text-align: center;
      width: 100px;
    }
#game-container, #end-screen, #leaderboardContainer {
  display: none;
}
#leaderboardContainer {
  display: none;
  margin: 40px auto;
  text-align: center;
  max-width: 800px;
}

#leaderboardContainer table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

#leaderboardContainer th, #leaderboardContainer td {
  padding: 10px;
  border-bottom: 1px solid #333;
  text-align: center;
}

#leaderboardContainer th {
  color: #1e90ff;
  font-weight: 600;
  border-bottom: 2px solid #1e90ff33;
}

#leaderboardContainer td {
  color: #ddd;
}

#leaderboardContainer tr:hover td {
  background: #1e90ff22;
}
    
    #end-screen {
  display: none;
  text-align: center;
  margin-top: 80px;
  color: white;
}

#end-screen h2 {
  color: #1e90ff;
  font-size: 48px;
  margin-bottom: 10px;
}

#end-screen h3 {
  color: #ff4d4d;
  margin-top: 0;
  font-size: 28px;
}

#end-screen p {
  margin: 5px 0;
  font-size: 18px;
}

#end-screen .mode-label {
  background: #222;
  border: 1px solid #1e90ff;
  color: #1e90ff;
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 14px;
  margin-bottom: 10px;
}

#end-screen button {
  background: #1e90ff;
  border: none;
  color: white;
  padding: 10px 20px;
  font-size: 16px;
  border-radius: 6px;
  margin: 10px;
  cursor: pointer;
  transition: background 0.3s;
}

#end-screen button:hover {
  background: #00bfff;
}

#session-id {
  color: #aaa;
  font-size: 14px;
  margin-top: 5px;
}

#saved-status {
  color: #00ff90;
  font-size: 14px;
  margin-top: 2px;
}

    
#question {
  font-size: 48px;
  font-weight: bold;
  margin-top: 80px;
  margin-bottom: 30px;
}

#timerBar {
  width: 70%;
  height: 30px;
  background: #222;
  border-radius: 15px;
  margin: 40px auto;
  overflow: hidden;
  box-shadow: 0 0 10px #1e90ff55;
}

#timerFill {
  height: 100%;
  background: linear-gradient(90deg, #1e90ff, #00bfff);
  width: 100%;
  transition: width 0.25s linear;
}

#answer {
  font-size: 32px;
  padding: 10px;
  border-radius: 8px;
  border: 2px solid #1e90ff;
  width: 120px;
  background: #111;
  color: white;
  text-align: center;
  outline: none;
  box-shadow: 0 0 10px #1e90ff33;
  margin-bottom: 20px;
}

#answer:focus {
  border-color: #00bfff;
  box-shadow: 0 0 15px #00bfff55;
}

#stage-info {
  margin-top: 10px;
  font-size: 18px;
  color: #bbb;
}

  </style>
</head>
<body>
  <h1>IronMath</h1>

  <!-- Sign-In Screen -->
  <div id="login-screen">
    <p>Please sign in with your Microsoft account to continue.</p>
    <button id="loginBtn">Sign in with Microsoft</button>
    <p id="loginStatus" style="color:#f55;"></p>
  </div>

<div id="game-container">
  <div id="question"></div>
  <div id="timerBar"><div id="timerFill"></div></div>
  <input id="answer" type="text" autocomplete="off" placeholder="?" />
  <div id="stage-info"></div>
</div>


<div id="end-screen">
  <div class="mode-label">Typing Mode</div>
  <h3>Game Over</h3>

  <p id="end-stage">Stage reached: —</p>
  <p id="end-questions">Questions answered: —</p>
  <p id="end-penalty">Total penalty time: — s</p>
  <p id="end-total">Total time: — s (<span id="end-with-penalty">—</span> s with penalties)</p>
  <p id="end-avg">Avg time/question: — s (<span id="end-avg-with-penalty">—</span> s with penalties)</p>

  <p id="session-id"></p>
  <p id="saved-status"></p>

  <button id="restartBtn">Restart</button>
  <button id="viewLeaderboardBtn">View Leaderboard</button>
</div>


  <!-- Firebase + Game Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import {
  getAuth,
  OAuthProvider,
  signInWithPopup,
  setPersistence,
  browserLocalPersistence,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ---- Fill in your Firebase Config here ----
const firebaseConfig = {
  apiKey: "AIzaSyBUaOrUckCuTrc9MHB9jCF4TUsx-hWFC7g",
  authDomain: "ironmath-1263b.firebaseapp.com",
  projectId: "ironmath-1263b",
  storageBucket: "ironmath-1263b.firebasestorage.app",
  messagingSenderId: "729878130193",
  appId: "1:729878130193:web:f4d447b552e4f955f80bb0",
  measurementId: "G-0VCM7C1HPC"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    // Keep user logged in across refreshes
setPersistence(auth, browserLocalPersistence);

// If already signed in, skip login screen
onAuthStateChanged(auth, (user) => {
  if (user) {
    playerName = user.displayName || parseEmailToName(user.email);
    loginScreen.style.display = "none";
    startGame();
  }
});
    const db = getFirestore(app);

    const loginScreen = document.getElementById("login-screen");
    const loginBtn = document.getElementById("loginBtn");
    const loginStatus = document.getElementById("loginStatus");
    const gameContainer = document.getElementById("game-container");
    const endScreen = document.getElementById("end-screen");
    const questionEl = document.getElementById("question");
    const answerEl = document.getElementById("answer");
    const stageInfo = document.getElementById("stage-info");
    const timerFill = document.getElementById("timerFill");
    const finalStats = document.getElementById("finalStats");

    const viewBtn = document.getElementById("viewLeaderboardBtn");
    const leaderboardContainer = document.getElementById("leaderboardContainer");
    const tbody = document.querySelector("#leaderboardContainer tbody");
    const statusEl = document.getElementById("leaderboardStatus");

    let playerName = "Unknown";
    let sessionId = Math.random().toString(36).substring(2, 8);
    let stage = 8;
    let running = false;
    let totalQuestions = 0;
    let correctAnswers = 0;
    let totalTime = 0;
    let penaltyTime = 0;
    let avgTime = 0;
    let startTime;
    let timer = 10;
    let timerInterval;
    let penaltyMultiplier = 2;
    let recentAnswers = [];
    let duplicateProtectionCount = 25;

    const sigma = 6;
    const stageStretch = 0.5;
    const weightDecay = 0.9;

    let questionStart;
    let currentQuestion;
    let weightMap = {};

    // --- Microsoft Login ---
    loginBtn.addEventListener("click", async () => {
      const provider = new OAuthProvider("microsoft.com");
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        playerName = user.displayName || parseEmailToName(user.email);
        loginScreen.style.display = "none";
        startGame();
      } catch (error) {
        console.error(error);
        loginStatus.textContent = "Sign-in failed: " + error.message;
      }
    });

    function parseEmailToName(email) {
      if (!email) return "Unknown";
      const local = email.split("@")[0];
      if (local.includes(".")) {
        const [f, l] = local.split(".");
        return `${capitalize(f)} ${capitalize(l)}`;
      } else return capitalize(local);
    }
    function capitalize(str) { return str.charAt(0).toUpperCase() + str.slice(1); }

    // --- Game logic ---
    function startGame() {
      gameContainer.style.display = "block";
      running = true;
      nextQuestion();
    }

    function randomQuestion() {
      const range = stage + Math.sqrt(stage) * stageStretch;
      const floor = Math.max(1, Math.sqrt(stage) + 1);
      const a = Math.floor(Math.random() * range) + 1;
      const b = Math.floor(Math.random() * range) + 1;
      return [a, b];
    }

    function nextQuestion() {
      clearInterval(timerInterval);
      const [a, b] = randomQuestion();
      const product = a * b;
      if (recentAnswers.includes(product)) return nextQuestion();
      recentAnswers.unshift(product);
      if (recentAnswers.length > duplicateProtectionCount) recentAnswers.pop();
      currentQuestion = { a, b, ans: product };
      questionEl.textContent = `${a} × ${b}`;
      answerEl.value = "";
      stageInfo.textContent = `Stage ${stage}`;
      timer = 10;
      questionStart = performance.now();
      startTimer();
      answerEl.focus();
    }

    function startTimer() {
      const start = performance.now();
      timerInterval = setInterval(() => {
        const elapsed = (performance.now() - start) / 1000;
        const remaining = Math.max(0, 10 - elapsed);
        timerFill.style.width = `${(remaining / 10) * 100}%`;
        if (remaining <= 0) {
          clearInterval(timerInterval);
          endGame();
        }
      }, 100);
    }

    answerEl.addEventListener("input", () => {
      if (!running) return;
      const val = answerEl.value.trim();
      if (val === "") return;
      if (val === currentQuestion.ans.toString()) {
        const qTime = (performance.now() - questionStart) / 1000;
        totalTime += qTime;
        correctAnswers++;
        totalQuestions++;
        avgTime = totalTime / correctAnswers;
        nextQuestion();
      } else if (!currentQuestion.ans.toString().startsWith(val)) {
        penaltyTime += avgTime || 2;
        timer -= avgTime * penaltyMultiplier;
        answerEl.value = val.slice(0, -1);
        if (timer <= 0) endGame();
      }
    });

    function endGame() {
      running = false;
      clearInterval(timerInterval);
      gameContainer.style.display = "none";
      endScreen.style.display = "block";

      const trueTotal = totalTime;
      const modTotal = totalTime + penaltyTime;
      const perQ = (trueTotal / correctAnswers).toFixed(2);
      const perQmod = (modTotal / correctAnswers).toFixed(2);

      finalStats.innerHTML = `
        <strong>Stage:</strong> ${stage}<br>
        <strong>Questions:</strong> ${correctAnswers}<br>
        <strong>Total Time:</strong> ${trueTotal.toFixed(2)} s <span style="color:#888;">(${modTotal.toFixed(2)} s w/ penalty)</span><br>
        <strong>Time/Question:</strong> ${perQ} s <span style="color:#888;">(${perQmod} s w/ penalty)</span><br>
        <strong>Penalty Time:</strong> ${penaltyTime.toFixed(2)} s<br>
        <strong>Session ID:</strong> ${sessionId}
      `;
document.getElementById("restartBtn").addEventListener("click", () => {
  // Reset key variables but keep the signed-in user
  stage = 8;
  totalQuestions = 0;
  correctAnswers = 0;
  totalTime = 0;
  penaltyTime = 0;
  avgTime = 0;
  running = false;
  recentAnswers = [];
  endScreen.style.display = "none";
  gameContainer.style.display = "block";
  startGame();
});
      uploadSession();
    }

    async function uploadSession() {
      try {
        await addDoc(collection(db, "sessions"), {
          playerName,
          sessionId,
          stageReached: stage,
          questionsAnswered: correctAnswers,
          totalTime,
          penaltyTime,
          avgTime,
          dateAdded: Date.now()
        });
      } catch (err) {
        console.error("Upload failed", err);
      }
    }

    // --- Leaderboard ---
    viewBtn?.addEventListener("click", loadLeaderboard);

    async function loadLeaderboard() {
      try {
        statusEl.textContent = "Loading leaderboard...";
        leaderboardContainer.style.display = "block";

        const q = query(
          collection(db, "leaderboard"),
          orderBy("questionsAnswered", "desc"),
          orderBy("totalTime", "asc")
        );
        const snap = await getDocs(q);

        const grouped = {};
        snap.forEach(doc => {
          const d = doc.data();
          if (!d.playerName) return;
          const key = d.playerName.trim().toLowerCase();
          if (!grouped[key]) grouped[key] = [];
          grouped[key].push(d);
        });

        const bestRuns = Object.values(grouped).map(entries => {
          return entries.sort((a, b) => {
            if (b.questionsAnswered === a.questionsAnswered)
              return a.totalTime - b.totalTime;
            return b.questionsAnswered - a.questionsAnswered;
          })[0];
        });

        bestRuns.sort((a, b) => {
          if (b.questionsAnswered === a.questionsAnswered)
            return a.totalTime - b.totalTime;
          return b.questionsAnswered - a.questionsAnswered;
        });

        tbody.innerHTML = "";
        let rank = 1;
        for (const d of bestRuns.slice(0, 100)) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${rank++}</td>
            <td>${d.playerName}</td>
            <td>${d.stageReached ?? "?"}</td>
            <td>${d.questionsAnswered ?? "?"}</td>
            <td>${(d.totalTime ?? 0).toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        }

        statusEl.textContent = "";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "Failed to load leaderboard: " + err.message;
      }
    }
  </script>
</body>
</html>
