name: Export Firestore Data for Supabase

on:
  workflow_dispatch: {}

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create export script + package.json
        shell: bash
        run: |
          set -euo pipefail
          rm -rf scripts
          mkdir -p scripts/outputs

          cat > scripts/package.json <<'EOF'
          {
            "name": "ironmath-firestore-export",
            "private": true,
            "type": "commonjs",
            "dependencies": {
              "@google-cloud/firestore": "^7.10.0"
            }
          }
          EOF

          cat > scripts/export_fire_to_csv.cjs <<'EOF'
          const fs = require("fs");
          const path = require("path");
          const { Firestore } = require("@google-cloud/firestore");

          function getFirestore() {
            const raw = process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON;
            if (!raw) throw new Error("Missing GOOGLE_APPLICATION_CREDENTIALS_JSON secret");
            const creds = JSON.parse(raw);

            return new Firestore({
              projectId: creds.project_id,
              credentials: {
                client_email: creds.client_email,
                private_key: creds.private_key,
              },
            });
          }

          function toDate(millis) {
            if (!millis || typeof millis !== "number") return new Date(0);
            return new Date(millis);
          }

          function csvEscape(v) {
            if (v === null || v === undefined) return "";
            const s = String(v);
            return /[",\n]/.test(s)
              ? '"' + s.replace(/"/g, '""') + '"'
              : s;
          }

          async function main() {
            const firestore = getFirestore();
            const outDir = path.join(process.cwd(), "outputs");
            fs.mkdirSync(outDir, { recursive: true });

            /* ========== USER CACHE ========== */
            const users = {}; // nameKey -> {name, earliest, latest}
            const nameKey = s => (s || "Unknown").trim().toLowerCase();

            /* ========== SESSIONS EXPORT ========== */
            const sessionsSnap = await firestore.collection("sessions").get();
            console.log("Found " + sessionsSnap.size + " session docs");

            const sessionsRows = [
              "name,questions_answered,true_time_seconds,penalty_time_seconds,total_time_seconds,stage_reached,created_at"
            ];

            /* QUESTIONS */
            const questionsRows = [
              "session_name,a,b,time_taken,mistakes,success,date_added,player_name"
            ];

            for (const doc of sessionsSnap.docs) {
              const s = doc.data() || {};
              const pname = s.playerName || "Unknown";
              const key = nameKey(pname);

              const createdAt = toDate(s.dateAdded);

              // Add to user cache
              if (!users[key]) {
                users[key] = {
                  name: pname,
                  earliest: createdAt,
                  latest: createdAt,
                };
              } else {
                if (createdAt < users[key].earliest) users[key].earliest = createdAt;
                if (createdAt > users[key].latest) users[key].latest = createdAt;
              }

              const questionsAnswered = s.questionsAnswered ?? 0;
              const trueTime = s.totalTime ?? 0;
              const penalty = s.penaltyTime ?? 0;
              const total = trueTime + penalty;
              const stage = s.stageReached ?? "";

              sessionsRows.push([
                csvEscape(pname),
                csvEscape(questionsAnswered),
                csvEscape(trueTime),
                csvEscape(penalty),
                csvEscape(total),
                csvEscape(stage),
                csvEscape(createdAt.toISOString())
              ].join(","));

              const answers = Array.isArray(s.answers) ? s.answers : null;
              if (answers) {
                for (const ans of answers) {
                  const qDate = ans.dateAdded ? toDate(ans.dateAdded) : createdAt;
                  questionsRows.push([
                    csvEscape(pname),
                    csvEscape(ans.a ?? ""),
                    csvEscape(ans.b ?? ""),
                    csvEscape(ans.timeTaken ?? ""),
                    csvEscape(ans.mistakes ?? ""),
                    csvEscape(ans.success ?? false),
                    csvEscape(qDate.toISOString()),
                    csvEscape(pname)
                  ].join(","));
                }
              }
            }

            /* ========== LEADERBOARD EXPORT ========== */
            const lbSnap = await firestore.collection("leaderboard").get();
            console.log("Found " + lbSnap.size + " leaderboard docs");

            const leaderboardRows = [
              "player_name,stage_reached,questions_answered,total_time_seconds,penalty_time_seconds,date_added,is_teacher,is_student"
            ];

            for (const doc of lbSnap.docs) {
              const d = doc.data() || {};
              const pname = d.playerName || "Unknown";
              const key = nameKey(pname);

              const createdAt = toDate(d.dateAdded);
              const stage = d.stageReached ?? "";
              const q = d.questionsAnswered ?? 0;
              const trueT = d.totalTime ?? 0;
              const penT = d.penaltyTime ?? 0;
              const totT = trueT + penT;
              const isTeacher = !!d.isTeacher;
              const isStudent = !!d.isStudent;

              // update user seen times
              if (!users[key]) {
                users[key] = {
                  name: pname,
                  earliest: createdAt,
                  latest: createdAt,
                };
              } else {
                if (createdAt < users[key].earliest) users[key].earliest = createdAt;
                if (createdAt > users[key].latest) users[key].latest = createdAt;
              }

              leaderboardRows.push([
                csvEscape(pname),
                csvEscape(stage),
                csvEscape(q),
                csvEscape(totT),
                csvEscape(penT),
                csvEscape(createdAt.toISOString()),
                csvEscape(isTeacher),
                csvEscape(isStudent)
              ].join(","));
            }

            /* ========== USERS EXPORT ========== */
            const usersRows = [
              "name,created_at,last_login_at"
            ];

            for (const key in users) {
              const u = users[key];
              usersRows.push([
                csvEscape(u.name),
                csvEscape(u.earliest.toISOString()),
                csvEscape(u.latest.toISOString())
              ].join(","));
            }

            /* ========== LOGINS EXPORT ========== */
            const loginsRows = [
              "name,login_at"
            ];

            for (const key in users) {
              const u = users[key];
              // create one synthetic "login" event at last use
              loginsRows.push([
                csvEscape(u.name),
                csvEscape(u.latest.toISOString())
              ].join(","));
            }

            /* ========== SAVE FILES ========== */
            fs.writeFileSync(path.join(outDir, "users_export.csv"), usersRows.join("\n"));
            fs.writeFileSync(path.join(outDir, "logins_export.csv"), loginsRows.join("\n"));
            fs.writeFileSync(path.join(outDir, "sessions_export.csv"), sessionsRows.join("\n"));
            fs.writeFileSync(path.join(outDir, "questions_export.csv"), questionsRows.join("\n"));
            fs.writeFileSync(path.join(outDir, "leaderboard_export.csv"), leaderboardRows.join("\n"));

            console.log("All CSV exports complete.");
          }

          main().catch(err => {
            console.error("Export failed:", err);
            process.exit(1);
          });
          EOF

      - name: Install dependencies
        run: npm install
        working-directory: ./scripts

      - name: Run export script
        run: node export_fire_to_csv.cjs
        working-directory: ./scripts
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

      - name: Upload CSV Files
        uses: actions/upload-artifact@v4
        with:
          name: firestore-csv-exports
          path: scripts/outputs/*.csv
          if-no-files-found: error
