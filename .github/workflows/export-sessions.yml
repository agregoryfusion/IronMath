name: Export Firestore Sessions to CSV (one-time)

on:
  workflow_dispatch: {}

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Create clean script files
        shell: bash
        run: |
          set -euo pipefail
          rm -rf scripts
          mkdir -p scripts/outputs

          cat > scripts/package.json <<'EOF'
          {
            "name": "ironmath-firestore-export",
            "private": true,
            "type": "commonjs",
            "dependencies": {
              "@google-cloud/firestore": "^7.10.0"
            }
          }
          EOF

          cat > scripts/export_sessions.cjs <<'EOF'
          const fs = require("fs");
          const path = require("path");
          const { Firestore } = require("@google-cloud/firestore");

          function getFirestoreFromEnv() {
            const raw = process.env.GOOGLE_APPLICATION_CREDENTIALS_JSON;
            if (!raw) throw new Error("Missing env GOOGLE_APPLICATION_CREDENTIALS_JSON");
            const creds = JSON.parse(raw);
            return new Firestore({
              projectId: creds.project_id,
              credentials: { client_email: creds.client_email, private_key: creds.private_key },
            });
          }

          function csvEscape(value) {
            if (value === null || value === undefined) return "";
            const s = String(value);
            return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
          }

          async function main() {
            const db = getFirestoreFromEnv();

            const outDir = path.join(process.cwd(), "outputs");
            fs.mkdirSync(outDir, { recursive: true });

            const sessionsCsv = [
              "dateAdded,penaltyTime,playerName,questionsAnswered,sessionID,stageReached,totalTime",
            ];
            const answersCsv = [
              "a,b,dateAdded,mistakes,stage,success,timeTaken,playerName",
            ];

            const snap = await db.collection("sessions").get();
            console.log(`Found ${snap.size} session docs`);

            snap.forEach((doc) => {
              const s = doc.data() || {};

              // sessions_export.csv
              const row = [
                s.dateAdded ?? "",
                s.penaltyTime ?? "",
                s.playerName ?? "",
                s.questionsAnswered ?? "",
                s.sessionID ?? doc.id,
                s.stageReached ?? "",
                s.totalTime ?? "",
              ].map(csvEscape).join(",");
              sessionsCsv.push(row);

              // answers_export.csv (flatten answers array if present)
              const answers = Array.isArray(s.answers) ? s.answers : null;
              if (answers && answers.length) {
                for (const a of answers) {
                  const arow = [
                    a.a ?? "",
                    a.b ?? "",
                    a.dateAdded ?? "",
                    a.mistakes ?? "",
                    a.stage ?? "",
                    a.success ?? "",
                    a.timeTaken ?? "",
                    s.playerName ?? "",
                  ].map(csvEscape).join(",");
                  answersCsv.push(arow);
                }
              }
            });

            fs.writeFileSync(path.join(outDir, "sessions_export.csv"), sessionsCsv.join("\n"));
            fs.writeFileSync(path.join(outDir, "answers_export.csv"), answersCsv.join("\n"));

            console.log("Wrote outputs/sessions_export.csv and outputs/answers_export.csv");
          }

          main().catch((err) => {
            console.error(err);
            process.exit(1);
          });
          EOF

          echo "----- File head (export_sessions.cjs) -----"
          sed -n '1,80p' scripts/export_sessions.cjs
          echo "------------------------------------------"

      - name: Install deps
        run: npm install
        working-directory: ./scripts

      - name: Run export
        run: node export_sessions.cjs
        working-directory: ./scripts
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}

      - name: Upload CSVs
        uses: actions/upload-artifact@v4
        with:
          name: firestore-csv-exports
          path: scripts/outputs/*.csv
          if-no-files-found: error
